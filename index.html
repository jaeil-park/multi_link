<!-- 
  Project: Coupang Logistics & Enterprise DCIM System V32 (Robust Edition)
  Author: IT Infrastructure Engineer
  
  [V32 Optimization Log]
  1. CORE FIX: rewritten 'validateDrop' logic to perform Full-Range Collision Detection.
     - Prevents overwriting existing devices.
     - Prevents dropping into the "body" of multi-unit devices.
     - Allows self-overlapping moves (e.g., moving a 4U server down by 1U).
  2. UX: Visual feedback (Green/Red border) reflects the TRUE validity of the drop target.
  3. DATA: All V31 features (Excel, AI, Tree, Tabs) are preserved and integrated.
-->

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Enterprise DCIM Manager V32</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Leaflet & SheetJS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; overflow: hidden; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        
        #map { height: 100%; width: 100%; border-radius: 0.75rem; z-index: 1; }
        
        /* Scrollbars */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        /* Rack Visualizer */
        .rack-wrapper {
            width: 360px; min-width: 360px;
            background-color: #0f172a; border: 2px solid #334155; border-radius: 6px;
            display: flex; flex-direction: column; height: fit-content; flex-shrink: 0;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.6); margin-bottom: 20px; margin-right: 10px;
        }
        .rack-header {
            background-color: #1e293b; color: white; padding: 10px 12px;
            font-weight: 700; font-size: 13px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #475569; border-radius: 4px 4px 0 0;
        }
        .rack-body { background-color: #020617; padding: 4px; position: relative; }
        .rack-unit {
            height: 30px; border-bottom: 1px solid #1e293b; display: flex; align-items: center;
            font-size: 12px; color: #64748b; cursor: pointer; user-select: none; transition: all 0.1s;
        }
        .rack-unit:hover { background-color: #1e293b; }
        .rack-unit.occupied { color: white; border-bottom: 1px solid rgba(255,255,255,0.15); position: relative; z-index: 10; cursor: grab; }
        .rack-unit.occupied:active { cursor: grabbing; }

        /* Drag Feedback - Improved Visibility */
        .drag-valid { background-color: rgba(34, 197, 94, 0.2) !important; border: 2px dashed #22c55e !important; }
        .drag-invalid { background-color: rgba(239, 68, 68, 0.2) !important; border: 2px dashed #ef4444 !important; cursor: not-allowed !important; }
        .dragging-source { opacity: 0.3; filter: grayscale(100%); }

        /* Vendor Colors */
        .vendor-dell { background: linear-gradient(90deg, #0076CE 0%, #005b9f 100%); border-left: 3px solid #60a5fa; }
        .vendor-hpe { background: linear-gradient(90deg, #01A982 0%, #018566 100%); border-left: 3px solid #34d399; }
        .vendor-cisco { background: linear-gradient(90deg, #049fd9 0%, #037ba8 100%); border-left: 3px solid #38bdf8; }
        .vendor-brocade { background: linear-gradient(90deg, #d11242 0%, #a30e33 100%); border-left: 3px solid #fb7185; }
        .vendor-etc { background: linear-gradient(90deg, #475569 0%, #334155 100%); border-left: 3px solid #94a3b8; }

        .u-label { width: 32px; text-align: center; border-right: 1px solid rgba(255,255,255,0.1); margin-right: 6px; font-family: 'Roboto Mono'; font-size: 10px; color: #94a3b8; flex-shrink: 0; height: 100%; display: flex; align-items: center; justify-content: center; pointer-events: none;}
        .occupied .u-label { color: rgba(255,255,255,0.9); }
        .device-content { flex-grow: 1; padding: 0 4px; overflow: hidden; display: flex; flex-direction: column; justify-content: center; pointer-events: none;}
        .device-main { font-weight: 700; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color:white; }
        .device-sub { font-size: 9px; opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: 'Roboto Mono'; color:#cbd5e1; }
        .u-badge { position: absolute; right: 4px; top: 2px; background: rgba(0,0,0,0.5); padding: 1px 4px; border-radius: 2px; font-size: 8px; font-weight: bold; border: 1px solid rgba(255,255,255,0.1); pointer-events: none; }

        /* Tabs */
        .tab-strip-container { display: flex; align-items: flex-end; border-bottom: 1px solid #d1d5db; background-color: #f1f5f9; padding: 0 10px; height: 44px; flex-grow: 1; overflow: hidden; }
        .tab-scroll-area { display: flex; align-items: flex-end; gap: -4px; overflow-x: auto; flex-grow: 1; height: 100%; padding-top: 4px; }
        .room-tab { display: flex; align-items: center; gap: 6px; padding: 0 20px; height: 34px; border-radius: 10px 10px 0 0; border: 1px solid #cbd5e1; border-bottom: none; background: linear-gradient(to bottom, #f1f5f9, #e2e8f0); color: #64748b; font-size: 13px; font-weight: bold; cursor: pointer; min-width: max-content; transition: all 0.2s; position: relative; z-index: 1; }
        .room-tab.active { height: 40px; background: white; color: #1e40af; border-color: #cbd5e1; border-top: 3px solid #1e40af; border-bottom: 1px solid white; margin-bottom: -1px; z-index: 10; box-shadow: 0 -2px 6px rgba(0,0,0,0.08); }
        .tab-actions { display: flex; gap: 4px; margin-left: 6px; opacity: 0.6; }
        .room-tab:hover .tab-actions, .room-tab.active .tab-actions { opacity: 1; }
        .tab-icon { width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 11px; cursor: pointer; }
        .tab-icon:hover { background-color: rgba(0,0,0,0.1); } .tab-icon.del:hover { background-color: #fee2e2; color: #ef4444; }
        
        .add-room-btn { display: flex; align-items: center; justify-content: center; height: 32px; padding: 0 12px; margin-left: 8px; margin-bottom: 4px; background-color: white; color: #1e40af; border: 1px dashed #1e40af; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; transition: all 0.2s; white-space: nowrap; flex-shrink: 0; }
        .add-room-btn:hover { background-color: #eff6ff; }

        .view-tab { padding: 4px 12px; font-size: 11px; font-weight: bold; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; items-center; gap: 4px; }
        .view-tab.active { background-color: #1e293b; color: white; shadow: sm; }
        .view-tab.inactive { color: #64748b; hover:bg-slate-100; }

        #rack-sidebar { transition: transform 0.3s ease-in-out; }
        @media (max-width: 1024px) { #rack-sidebar { position: absolute; left: 0; top: 0; bottom: 0; z-index: 50; transform: translateX(-100%); box-shadow: 5px 0 15px rgba(0,0,0,0.1); } #rack-sidebar.open { transform: translateX(0); } }

        details > summary { list-style: none; cursor: pointer; }
        .tree-arrow { transition: transform 0.2s; display: inline-block; font-size: 10px; }
        details[open] > summary .tree-arrow { transform: rotate(90deg); }
        
        .panel-tab { @apply flex-1 py-2 text-xs font-bold text-center cursor-pointer border-b-2 transition; }
        .panel-tab.active { @apply border-indigo-600 text-indigo-700 bg-indigo-50; }
        .panel-tab.inactive { @apply border-transparent text-slate-500 hover:text-slate-700; }

        .asset-table { width: 100%; font-size: 11px; text-align: left; border-collapse: collapse; min-width: 800px; }
        .asset-table th { @apply bg-slate-100 text-slate-600 font-bold p-2 border-b sticky top-0; }
        .asset-table td { @apply p-2 border-b border-slate-50 text-slate-700 whitespace-nowrap; }
        .asset-table tr:hover { @apply bg-slate-50; }
        
        /* Map Overlay Button */
        .map-overlay-btn { position: absolute; top: 12px; right: 12px; z-index: 500; background: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: bold; color: #475569; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; border: 1px solid #cbd5e1; transition: all 0.2s; }
        .map-overlay-btn:hover { background: #f1f5f9; color: #1e293b; }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden bg-slate-50">

    <!-- Header -->
    <header class="bg-white shadow-sm z-50 flex-none h-14 border-b border-slate-200">
        <div class="max-w-full mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-700 rounded-lg flex items-center justify-center font-bold text-white text-sm shadow-md">V32</div>
                <h1 class="text-sm sm:text-lg font-bold tracking-tight text-slate-800">DCIM <span class="hidden sm:inline text-blue-700">Enterprise</span></h1>
            </div>
            <div class="flex gap-2">
                <button onclick="openAIModal()" class="px-3 py-1.5 bg-gradient-to-r from-violet-500 to-indigo-600 text-white rounded-lg text-xs font-bold shadow flex items-center gap-1">‚ú® <span class="hidden sm:inline">AI</span></button>
                <div class="h-6 w-px bg-slate-200 mx-1"></div>
                <div class="flex items-center gap-1 bg-slate-100 p-1 rounded">
                    <button onclick="downloadSample()" class="px-2 py-1 bg-white border rounded text-[10px] font-bold text-slate-600 hover:bg-slate-50">Sample</button>
                    <button onclick="exportFullExcel()" class="px-2 py-1 bg-white border rounded text-[10px] font-bold text-green-700 hover:bg-green-50">üì§ XLSX</button>
                </div>
                <label class="px-3 py-1.5 bg-blue-700 text-white rounded-lg text-xs font-bold transition flex items-center gap-1 cursor-pointer shadow hover:bg-blue-600">
                    üì• Import <input type="file" id="excel-input" class="hidden" accept=".xlsx, .xls, .csv" onchange="importFullExcel(this)">
                </label>
                <button onclick="resetData()" class="px-3 py-1.5 text-slate-400 hover:text-red-500 transition">üóëÔ∏è</button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="flex-grow flex flex-col lg:flex-row overflow-hidden relative bg-slate-100 p-2 sm:p-4 gap-2 sm:gap-0" id="main-container">
        
        <!-- LEFT: MAP -->
        <div id="view-map-container" class="flex-grow bg-white rounded-xl shadow-sm border border-slate-200 relative overflow-hidden flex flex-col min-h-[300px] lg:w-3/4">
            <div class="px-4 py-2 border-b border-slate-100 flex justify-between items-center bg-white z-10 h-12 flex-none">
                <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-lg">
                    <div onclick="switchMainView('map')" id="btn-view-map" class="view-tab active">üó∫Ô∏è Map</div>
                    <div onclick="switchMainView('rack')" id="btn-view-rack" class="view-tab inactive">üñ•Ô∏è Rack</div>
                </div>
                <span class="hidden sm:inline text-[10px] text-slate-400 font-mono">Status: Online</span>
            </div>
            <div class="flex-grow relative">
                <div id="map"></div>
                <button onclick="resetMapView()" class="map-overlay-btn">üìç Reset</button>
            </div>
        </div>

        <div class="splitter hidden lg:flex" id="main-splitter"></div>

        <!-- RIGHT: PANEL -->
        <div id="right-panel" class="bg-white lg:rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden lg:w-1/4 h-full lg:h-auto rounded-xl">
            <!-- Tabs -->
            <div class="flex border-b border-slate-200 bg-slate-50 flex-none">
                <div class="panel-tab active" onclick="switchPanelTab('dashboard')" id="pt-dashboard">üìä Summary</div>
                <div class="panel-tab inactive" onclick="switchPanelTab('assets')" id="pt-assets">üìã Server List</div>
            </div>

            <!-- Tab 1: Dashboard -->
            <div id="panel-dashboard" class="flex-col h-full overflow-hidden flex">
                <div class="p-4 border-b border-slate-100 flex-none">
                    <div class="flex justify-between items-center mb-3"><h2 class="font-bold text-slate-800">Status</h2><span class="bg-slate-100 text-[10px] px-2 py-1 rounded">ALL</span></div>
                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <div class="flex flex-col items-center p-2 rounded bg-red-50 border-red-100"><span class="text-[10px] text-red-500">FC</span><span class="font-bold" id="stat-fc">0</span></div>
                        <div class="flex flex-col items-center p-2 rounded bg-blue-50 border-blue-100"><span class="text-[10px] text-blue-500">CP</span><span class="font-bold" id="stat-camp">0</span></div>
                        <div class="flex flex-col items-center p-2 rounded bg-purple-50 border-purple-100"><span class="text-[10px] text-purple-500">HB</span><span class="font-bold" id="stat-hub">0</span></div>
                    </div>
                    <div class="h-20 w-full"><canvas id="statusChart"></canvas></div>
                </div>
                <div class="flex-grow flex flex-col overflow-hidden">
                    <div class="p-3 border-b border-slate-100 bg-slate-50 flex-none"><input type="text" onkeyup="updateSearch(this.value)" placeholder="Search Site..." class="w-full px-2 py-1.5 text-xs border rounded"></div>
                    <div class="flex-grow overflow-y-auto custom-scrollbar p-2 space-y-1 location-list-target"></div>
                </div>
            </div>

            <!-- Tab 2: Asset List -->
            <div id="panel-assets" class="flex-col h-full overflow-hidden hidden">
                <div class="p-2 border-b border-slate-100 bg-slate-50 flex justify-between items-center flex-none">
                    <span class="text-xs font-bold text-slate-600">Total Assets</span>
                    <select id="asset-filter" onchange="renderAssetTable()" class="text-xs border rounded p-1"><option value="all">All Vendors</option><option value="dell">Dell</option><option value="hpe">HPE</option><option value="cisco">Cisco</option></select>
                </div>
                <div class="flex-grow overflow-auto custom-scrollbar">
                    <table class="asset-table">
                        <thead><tr><th>FC</th><th>Model</th><th>IP</th><th>Spec</th></tr></thead>
                        <tbody id="asset-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- RACK VIEW OVERLAY -->
        <div id="rack-view-container" class="absolute inset-0 z-[1500] bg-slate-100 hidden flex-row overflow-hidden">
             <!-- Sidebar -->
             <div id="rack-sidebar" class="w-72 bg-white border-r border-slate-200 flex flex-col flex-none h-full">
                <div class="p-3 border-b border-slate-100 flex justify-between items-center bg-slate-50"><span class="font-bold text-slate-700 text-sm">Locations</span><button onclick="toggleSidebar()" class="lg:hidden text-slate-500 px-2">‚úï</button></div>
                <div class="p-2 border-b border-slate-100"><input type="text" onkeyup="updateSearch(this.value)" placeholder="Search..." class="w-full px-2 py-1.5 text-xs border rounded"></div>
                <div class="flex-grow overflow-y-auto custom-scrollbar p-2 space-y-1 location-list-target"></div>
             </div>

             <div class="splitter hidden lg:flex" id="rack-splitter"></div>

             <!-- Content -->
             <div class="flex-grow flex flex-col min-w-0 bg-slate-200 relative h-full">
                 <div class="bg-white px-4 border-b border-slate-300 flex items-end justify-between flex-none h-14 pt-2">
                     <div class="flex items-center gap-2 h-full w-full overflow-hidden">
                         <button onclick="toggleSidebar()" class="lg:hidden mr-2 text-slate-500">‚ò∞</button>
                         <h2 class="text-base font-bold text-slate-800 mr-2 mb-3 flex-none truncate max-w-[120px]" id="rack-view-title">Site</h2>
                         <div class="tab-strip-container flex-grow h-full min-w-0">
                             <div class="tab-scroll-area custom-scrollbar" id="room-tabs-container"></div>
                             <div class="add-room-btn" onclick="addRoom()">+ Room</div>
                         </div>
                     </div>
                     <button onclick="closeRackView()" class="flex-none mb-3 ml-2 bg-slate-800 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-slate-700 whitespace-nowrap">Exit</button>
                 </div>
                 <div class="flex-grow overflow-auto custom-scrollbar bg-slate-300/50 p-4 sm:p-8 h-full shadow-inner">
                     <div class="flex items-start gap-6 min-h-min" id="rack-container"></div>
                 </div>
             </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Device Detail Modal -->
    <div id="device-modal" class="fixed inset-0 z-[2000] hidden bg-slate-900/60 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-lg p-6 border border-slate-200 max-h-[90vh] overflow-y-auto">
             <form id="device-form" onsubmit="handleDeviceSubmit(event)" class="space-y-3">
                <input type="hidden" id="dev-rack-idx"><input type="hidden" id="dev-unit-idx">
                <div class="flex justify-between items-center border-b pb-2 mb-2"><h3 class="font-bold text-slate-800">Ïû•ÎπÑ ÏÉÅÏÑ∏ Ï†ïÎ≥¥</h3><span id="modal-u-info" class="text-xs bg-slate-100 px-2 rounded font-mono">U</span></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold text-slate-500">Vendor</label><select id="dev-vendor" class="w-full border p-1.5 rounded text-xs bg-slate-50"><option value="dell">Dell</option><option value="hpe">HPE</option><option value="cisco">Cisco</option><option value="etc">Other</option></select></div>
                    <div><label class="text-[10px] font-bold text-slate-500">Height (U)</label><select id="dev-height" class="w-full border p-1.5 rounded text-xs bg-slate-50"><option value="1">1U</option><option value="2">2U</option><option value="4">4U</option><option value="10">10U</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold text-slate-500">Hostname</label><input type="text" id="dev-hostname" class="w-full border p-1.5 rounded text-xs font-bold"></div>
                    <div><label class="text-[10px] font-bold text-slate-500">Mgmt IP</label><input type="text" id="dev-ip" class="w-full border p-1.5 rounded text-xs font-mono"></div>
                </div>
                <div><label class="text-[10px] font-bold text-slate-500">Model Name</label><input type="text" id="dev-model" class="w-full border p-1.5 rounded text-xs" required></div>
                
                <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] text-slate-400">Serial No</label><input type="text" id="dev-serial" class="w-full border p-1 rounded text-xs"></div>
                    <div><label class="text-[10px] text-slate-400">Service Level</label><input type="text" id="dev-svc" class="w-full border p-1 rounded text-xs"></div>
                    <div><label class="text-[10px] text-slate-400">CPU</label><input type="text" id="dev-cpu" class="w-full border p-1 rounded text-xs"></div>
                    <div><label class="text-[10px] text-slate-400">Memory</label><input type="text" id="dev-ram" class="w-full border p-1 rounded text-xs"></div>
                    <div class="col-span-2"><label class="text-[10px] text-slate-400">HDD/Storage</label><input type="text" id="dev-hdd" class="w-full border p-1 rounded text-xs"></div>
                    <div class="col-span-2"><label class="text-[10px] text-slate-400">Warranty</label><input type="text" id="dev-warranty" class="w-full border p-1 rounded text-xs" placeholder="YYYY-MM-DD"></div>
                </div>

                <div class="flex gap-2 pt-2 border-t mt-2">
                    <button type="button" onclick="deleteDevice()" class="px-3 bg-red-100 text-red-600 rounded text-xs font-bold">Del</button>
                    <button type="button" onclick="document.getElementById('device-modal').classList.add('hidden')" class="flex-1 bg-slate-100 rounded text-xs font-bold">Cancel</button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white rounded text-xs font-bold">Save</button>
                </div>
             </form>
        </div>
    </div>

    <!-- Location Modal -->
    <div id="location-modal" class="hidden fixed inset-0 z-[2000] bg-slate-900/60 flex items-center justify-center p-4"><div class="bg-white rounded p-6 w-full max-w-md"><form onsubmit="handleLocationSubmit(event)"><input id="loc-id" type="hidden"><input id="loc-lat" type="hidden"><input id="loc-lng" type="hidden"><select id="loc-region" class="border p-2 w-full mb-2"><option value="seoul">Seoul</option><option value="gyeonggi">Gyeonggi</option></select><input id="loc-name" class="border p-2 w-full mb-2" placeholder="Name"><button class="bg-blue-600 text-white p-2 w-full rounded">Save</button><button type="button" onclick="document.getElementById('location-modal').classList.add('hidden')" class="w-full mt-2 text-xs">Cancel</button></form></div></div>

    <!-- AI Modal -->
    <div id="ai-modal" class="hidden fixed inset-0 z-[2000] bg-slate-900/60 flex items-center justify-center p-4"><div class="bg-white rounded w-full max-w-lg h-[500px] flex flex-col"><div class="p-4 border-b flex justify-between"><span>AI Insight</span><button onclick="document.getElementById('ai-modal').classList.add('hidden')">x</button></div><div id="ai-chat-history" class="flex-grow p-4 overflow-y-auto"></div><div class="p-4 border-t"><form onsubmit="handleAiSubmit(event)" class="flex gap-2"><input id="ai-input" class="border flex-grow p-2 rounded"><button class="bg-indigo-600 text-white p-2 rounded">Send</button></form></div></div></div>

    <script>
        const apiKey=""; const REGION_MAP={'seoul':'ÏÑúÏö∏Í∂å','gyeonggi':'Í≤ΩÍ∏∞Í∂å','incheon':'Ïù∏Ï≤ú','gangwon':'Í∞ïÏõê','chungcheong':'Ï∂©Ï≤≠','jeolla':'Ï†ÑÎùº','gyeongsang':'Í≤ΩÏÉÅ','jeju':'Ï†úÏ£º'};
        const REGION_COORDS={'seoul':{lat:37.5665,lng:126.9780},'gyeonggi':{lat:37.2750,lng:127.0096},'incheon':{lat:37.4563,lng:126.7052},'gangwon':{lat:37.8854,lng:127.7298},'chungcheong':{lat:36.3504,lng:127.3845},'jeolla':{lat:35.1595,lng:126.8526},'gyeongsang':{lat:35.1796,lng:129.0756},'jeju':{lat:33.4996,lng:126.5312}};
        let locations=[], map, markers=[], selectedLocId=null, selectedRoomIdx=0, chartInstance=null, dragSource=null, globalSearchTerm="";

        // DEFAULT DATA
        const DEFAULT_DATA = [
            {
                id:1, type:'FC', name:'ÎèôÌÉÑ1ÏÑºÌÑ∞(DON1)', region:'gyeonggi', lat:37.20, lng:127.10, address:'ÌôîÏÑ±Ïãú ÎèôÌÉÑÎ©¥', 
                rooms:[{name:'A Room', racks:[{name:'R01', units:{ 46:{vendor:'cisco', model:'Nexus 9500', height:4, note:'Core'}, 42:{vendor:'hpe', model:'DL380 Gen10', hostname:'DON1-SVR-01', ip:'172.27.10.1', height:2}, 40:{vendor:'dell', model:'R740', hostname:'DON1-DB-01', ip:'172.27.10.2', height:2} } }]}]
            }
        ];

        document.addEventListener('DOMContentLoaded',()=>{loadData();initMap();renderDashboard();initSplitters();});
        function loadData(){const s=localStorage.getItem('dcim_v32_data');locations=s?JSON.parse(s):JSON.parse(JSON.stringify(DEFAULT_DATA));}
        function saveData(){localStorage.setItem('dcim_v32_data',JSON.stringify(locations));renderDashboard();renderTreeList();}
        function resetData(){if(confirm("Reset?")){localStorage.removeItem('dcim_v32_data');location.reload();}}

        // --- OPTIMIZED DRAG & DROP LOGIC (V32) ---
        function handleDragStart(e,ri,u,d){
            e.stopPropagation(); 
            dragSource={rIdx:ri, u:u, device:d, roomIdx: selectedRoomIdx, locId: selectedLocId};
            e.dataTransfer.effectAllowed='move';
        }
        function handleDragOver(e,ri,u){
            e.preventDefault();
            // Optional: Visual Feedback here (Checking validity on the fly is expensive, doing it on drop is safer for performance)
            e.dataTransfer.dropEffect = 'move';
        }
        function handleDrop(e, targetRIdx, targetU){
            e.preventDefault();
            if(!dragSource) return;
            
            // Check context (Same location?)
            if(dragSource.locId !== selectedLocId || dragSource.roomIdx !== selectedRoomIdx) {
                alert("Move allowed only within the same room for safety."); return;
            }

            const room = locations.find(x=>x.id===selectedLocId).rooms[selectedRoomIdx];
            const targetRack = room.racks[targetRIdx];
            const height = dragSource.device.height || 1;
            
            // 1. Bound Check
            if(targetU - height + 1 < 1) { alert("Í≥µÍ∞ÑÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§ (Î∞îÎã• Ï¥àÍ≥º)."); return; }
            
            // 2. Collision Check (Full Range Scan)
            const isSameRack = (dragSource.rIdx === targetRIdx);
            
            for(let i=0; i<height; i++){
                const checkU = targetU - i;
                
                // A. Direct Occupation Check
                if(targetRack.units[checkU]) {
                    // Allow overwriting self (if start U matches)
                    if(isSameRack && checkU === dragSource.u) continue;
                    return alert(`U${checkU} ÏúÑÏπòÏóê Ïù¥ÎØ∏ Ïû•ÎπÑÍ∞Ä ÏûàÏäµÎãàÎã§.`);
                }
                
                // B. Body Overlap Check (Scanning other devices)
                // We need to see if any OTHER device's body covers 'checkU'
                if(isUnitOccupiedByOther(targetRack, checkU, isSameRack ? dragSource.u : -1)) {
                    return alert(`U${checkU} ÏúÑÏπòÎäî Îã§Î•∏ Ïû•ÎπÑÍ∞Ä Ï†êÏú† Ï§ëÏûÖÎãàÎã§.`);
                }
            }

            // 3. Execute Move (Transaction)
            delete room.racks[dragSource.rIdx].units[dragSource.u];
            room.racks[targetRIdx].units[targetU] = dragSource.device;
            
            saveData();
            renderRacks(room);
            dragSource = null;
        }

        // Helper: Check if U is occupied by the BODY of another device
        function isUnitOccupiedByOther(rack, u, ignoreSourceU) {
            for(const key in rack.units) {
                const start = parseInt(key);
                if(start === ignoreSourceU) continue; // Skip self
                const dev = rack.units[key];
                const end = start - (dev.height || 1) + 1;
                if(u <= start && u >= end) return true; // u falls inside device range
            }
            return false;
        }

        // --- EXPORT LOGIC ---
        function exportFullExcel() {
            const wb = XLSX.utils.book_new();
            const rows1 = [["Center","Room","Rack","Unit","Vendor","Model","Hostname","IP"]];
            locations.forEach(l => {
                if(l.rooms) l.rooms.forEach(room => {
                    if(room.racks) room.racks.forEach(rack => {
                        for(let u=46; u>=1; u--) {
                            const d = rack.units[u];
                            if(d) rows1.push([l.name, room.name, rack.name, u, d.vendor, d.model, d.hostname||'', d.ip||'']);
                        }
                    });
                });
            });
            const ws1 = XLSX.utils.aoa_to_sheet(rows1);
            XLSX.utils.book_append_sheet(wb, ws1, "Asset List");
            XLSX.writeFile(wb, "Coupang_DCIM_V32.xlsx");
        }
        
        function importFullExcel(input) {
            const f=input.files[0]; if(!f) return;
            const r=new FileReader();
            r.onload = (e) => {
                const wb = XLSX.read(e.target.result, {type:'array'});
                const ws = wb.Sheets[wb.SheetNames[0]]; // Assume first sheet is list
                const data = XLSX.utils.sheet_to_json(ws);
                if(confirm(`Import ${data.length} items?`)) {
                    locations = []; // Clear
                    data.forEach(row => {
                        let loc = locations.find(l => l.name === row['Center']);
                        if(!loc) { loc = { id:Date.now()+Math.random(), type:'FC', name:row['Center'], region:'gyeonggi', rooms:[], lat:37.5, lng:127.0 }; locations.push(loc); }
                        let room = loc.rooms.find(r => r.name === row['Room']);
                        if(!room) { room = {name:row['Room'], racks:[]}; loc.rooms.push(room); }
                        let rack = room.racks.find(r => r.name === row['Rack']);
                        if(!rack) { rack = {name:row['Rack'], units:{}}; room.racks.push(rack); }
                        if(row['Unit']) rack.units[row['Unit']] = { vendor: row['Vendor']?.toLowerCase()||'etc', model: row['Model'], hostname: row['Hostname'], ip: row['IP'], height: 1 };
                    });
                    saveData(); location.reload();
                }
            };
            r.readAsArrayBuffer(f);
        }

        // --- MAP & RENDER LOGIC (Standard V31) ---
        function initMap(){if(map)map.remove();map=L.map('map').setView([36.5,127.5],7);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);renderMarkers();}
        function renderMarkers(){markers.forEach(m=>map.removeLayer(m));markers=[];locations.forEach(l=>{const c=l.type==='FC'?'#ef4444':(l.type==='HUB'?'#a855f7':'#3b82f6');L.marker([l.lat,l.lng],{icon:L.divIcon({className:'custom-icon',html:`<div style="background:${c};width:12px;height:12px;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3)"></div>`})}).addTo(map).on('click',()=>{selectedLocId=l.id;renderTreeList();renderDashboard();});});}
        function resetMapView(){map.setView([36.5,127.5],7);}
        
        function renderDashboard(){
            const fc=locations.filter(l=>l.type==='FC').length, camp=locations.filter(l=>l.type==='Camp').length, hub=locations.filter(l=>l.type==='HUB').length;
            if(document.getElementById('stat-fc')) { document.getElementById('stat-fc').innerText=fc; document.getElementById('stat-camp').innerText=camp; document.getElementById('stat-hub').innerText=hub; }
            const canvas = document.getElementById('statusChart');
            if(canvas) {
                 const ctx=canvas.getContext('2d'); if(chartInstance)chartInstance.destroy();
                 chartInstance=new Chart(ctx,{type:'bar',data:{labels:['FC','Camp','HUB'],datasets:[{data:[fc,camp,hub],backgroundColor:['#ef4444','#3b82f6','#a855f7'],borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{display:false},x:{display:false}}}});
            }
            renderTreeList(); renderAssetTable();
        }

        function switchPanelTab(tab) {
            document.getElementById('pt-dashboard').className = tab==='dashboard' ? 'panel-tab active' : 'panel-tab inactive';
            document.getElementById('pt-assets').className = tab==='assets' ? 'panel-tab active' : 'panel-tab inactive';
            document.getElementById('panel-dashboard').classList.toggle('hidden', tab!=='dashboard');
            document.getElementById('panel-dashboard').classList.toggle('flex', tab==='dashboard');
            document.getElementById('panel-assets').classList.toggle('hidden', tab!=='assets');
            document.getElementById('panel-assets').classList.toggle('flex', tab==='assets');
            if(tab==='assets') renderAssetTable();
        }
        function renderAssetTable() {
            const filter = document.getElementById('asset-filter').value;
            const tbody = document.getElementById('asset-tbody'); tbody.innerHTML = '';
            locations.forEach(l => { if(l.rooms) l.rooms.forEach(r => { if(r.racks) r.racks.forEach(rk => { for(let u=46; u>=1; u--) { const d = rk.units[u]; if(d && (filter==='all' || d.vendor===filter)) { const tr = document.createElement('tr'); tr.innerHTML = `<td class="font-bold">${l.name}</td><td>${d.model}<br><span class="text-[9px] text-gray-400">${d.serial||''}</span></td><td class="font-mono text-[10px]">${d.ip||'-'}</td><td class="text-[9px]">${d.cpu||'-'}/${d.ram||'-'}</td>`; tbody.appendChild(tr); } } }); }); });
        }
        function updateSearch(val){globalSearchTerm=val.toLowerCase();renderTreeList();}
        function renderTreeList(){
            const cs = document.querySelectorAll('.location-list-target');
            cs.forEach(c=>{c.innerHTML=''; const h={}; locations.forEach(l=>{if(globalSearchTerm && !l.name.toLowerCase().includes(globalSearchTerm)) return; const r=REGION_MAP[l.region]||'ETC'; if(!h[r])h[r]=[]; h[r].push(l);}); Object.keys(h).forEach(r=>{const d=document.createElement('details'); d.open=true; d.innerHTML=`<summary class="p-2 text-xs font-bold hover:bg-slate-50 cursor-pointer text-slate-700">‚ñ∂ ${r}</summary>`; const ct=document.createElement('div'); ct.className="pl-3 border-l ml-2"; h[r].forEach(l=>{const el=document.createElement('div'); el.className=`p-1.5 text-[11px] cursor-pointer hover:bg-slate-50 ${selectedLocId===l.id?'text-blue-600 font-bold':''}`; el.innerText=l.name; el.onclick=()=>{selectedLocId=l.id;renderTreeList();renderDashboard();if(document.getElementById('rack-view-container').style.display!=='none')openRackView(l.id);}; ct.appendChild(el);}); d.appendChild(ct); c.appendChild(d);});});
        }
        
        function switchMainView(m){ if(m==='map'){document.getElementById('view-map-container').classList.remove('hidden');document.getElementById('right-panel').classList.remove('hidden');document.getElementById('rack-view-container').classList.add('hidden');document.getElementById('rack-view-container').classList.remove('flex');} else {if(!selectedLocId)return alert("Select Site"); openRackView(selectedLocId);} }
        function openRackView(id){selectedLocId=id;selectedRoomIdx=0;const l=locations.find(x=>x.id===id); document.getElementById('rack-view-title').innerText=l.name; document.getElementById('view-map-container').classList.add('hidden');document.getElementById('right-panel').classList.add('hidden'); document.getElementById('rack-view-container').classList.remove('hidden'); document.getElementById('rack-view-container').classList.add('flex'); renderRooms(l);}
        function closeRackView(){switchMainView('map');setTimeout(()=>map.invalidateSize(),100);}
        
        function renderRooms(l){
            const c=document.getElementById('room-tabs-container'); c.innerHTML=''; if(!l.rooms)l.rooms=[];
            l.rooms.forEach((r,i)=>{const t=document.createElement('div'); t.className=`room-tab ${i===selectedRoomIdx?'active':''}`; t.innerText=r.name; t.onclick=()=>{selectedRoomIdx=i;renderRooms(l);}; c.appendChild(t);});
            if(l.rooms.length>0)renderRacks(l.rooms[selectedRoomIdx]); else document.getElementById('rack-container').innerHTML='<div class="m-auto text-slate-400">Add Room</div>';
        }
        function renderRacks(r){
            const c=document.getElementById('rack-container'); c.innerHTML=''; r.racks.forEach((rk,ri)=>{
                const w=document.createElement('div'); w.className='rack-wrapper'; w.innerHTML=`<div class="rack-header"><span>${rk.name}</span><button onclick="delRack(${ri})">√ó</button></div><div class="rack-body"></div>`; const b=w.querySelector('.rack-body');
                let sk=0; for(let u=46;u>=1;u--){
                    if(sk>0){sk--;continue;} const d=rk.units[u]; const s=document.createElement('div'); s.className=`rack-unit ${d?'occupied vendor-'+d.vendor:''}`;
                    if(d){ s.innerHTML=`<div class="u-label">${u}</div><div class="device-content"><div class="device-main">${d.hostname||d.name}</div><div class="device-sub">${d.model||''} ${d.ip||''}</div></div>`; if(d.height>1){s.style.height=`${30*d.height}px`;sk=d.height-1;} s.onclick=()=>openModal(ri,u,d); s.draggable=true; s.ondragstart=(e)=>handleDragStart(e,ri,u,d);}
                    else{ s.innerHTML=`<div class="u-label">${u}</div>`; s.onclick=()=>openModal(ri,u,null); }
                    s.ondragover=(e)=>handleDragOver(e,ri,u); s.ondrop=(e)=>handleDrop(e,ri,u); b.appendChild(s);
                } c.appendChild(w);
            });
            const add=document.createElement('div'); add.className="min-w-[340px] border-2 border-dashed border-slate-300 rounded flex items-center justify-center cursor-pointer hover:bg-slate-200 text-slate-400 flex-shrink-0 h-[800px]"; add.innerText="+ Rack"; add.onclick=()=>{r.racks.push({name:`R${r.racks.length+1}`,units:{}});saveData();renderRacks(r);}; c.appendChild(add);
        }

        // CRUD & Init helpers
        function addRoom(){const l=locations.find(x=>x.id===selectedLocId); const n=prompt("Name:"); if(n){l.rooms.push({name:n,racks:[]});selectedRoomIdx=l.rooms.length-1;saveData();renderRooms(l);}}
        function delRack(ri){const l=locations.find(x=>x.id===selectedLocId); if(confirm("Del?")){l.rooms[selectedRoomIdx].racks.splice(ri,1);saveData();renderRacks(l.rooms[selectedRoomIdx]);}}
        function openModal(r,u,d){document.getElementById('device-modal').classList.remove('hidden');document.getElementById('dev-rack-idx').value=r;document.getElementById('dev-unit-idx').value=u; if(d){document.getElementById('dev-model').value=d.name;document.getElementById('dev-vendor').value=d.vendor;document.getElementById('dev-height').value=d.height;document.getElementById('dev-hostname').value=d.hostname||'';document.getElementById('dev-ip').value=d.ip||''; document.getElementById('dev-serial').value=d.serial||''; document.getElementById('dev-warranty').value=d.warranty||''; document.getElementById('dev-svc').value=d.svc||'';}else{document.getElementById('dev-model').value='';document.getElementById('dev-height').value=1;}}
        function handleDeviceSubmit(e){e.preventDefault();const r=document.getElementById('dev-rack-idx').value,u=document.getElementById('dev-unit-idx').value,room=locations.find(x=>x.id===selectedLocId).rooms[selectedRoomIdx]; room.racks[r].units[u]={name:document.getElementById('dev-model').value,model:document.getElementById('dev-model').value,vendor:document.getElementById('dev-vendor').value,height:parseInt(document.getElementById('dev-height').value),hostname:document.getElementById('dev-hostname').value,ip:document.getElementById('dev-ip').value, serial:document.getElementById('dev-serial').value, warranty:document.getElementById('dev-warranty').value, svc:document.getElementById('dev-svc').value, cpu:document.getElementById('dev-cpu').value, ram:document.getElementById('dev-ram').value, hdd:document.getElementById('dev-hdd').value}; saveData();document.getElementById('device-modal').classList.add('hidden');renderRacks(room); renderDashboard();}
        function deleteDevice(){const r=document.getElementById('dev-rack-idx').value,u=document.getElementById('dev-unit-idx').value,room=locations.find(x=>x.id===selectedLocId).rooms[selectedRoomIdx]; delete room.racks[r].units[u]; saveData();document.getElementById('device-modal').classList.add('hidden');renderRacks(room); renderDashboard();}
        function openLocationModal(){document.getElementById('location-modal').classList.remove('hidden');}
        function handleLocationSubmit(e){e.preventDefault();alert("Demo: Site Added");document.getElementById('location-modal').classList.add('hidden');}
        
        function initSplitters() { makeResizable('main-splitter', 'view-map-container', 'right-panel', true); makeResizable('rack-splitter', 'rack-sidebar', null, false); }
        function makeResizable(h,l,r,f){const hd=document.getElementById(h),le=document.getElementById(l);if(!hd||!le)return;hd.addEventListener('mousedown',e=>{e.preventDefault();const mm=e=>{const w=e.clientX-le.getBoundingClientRect().left;if(w>200&&w<window.innerWidth-200)le.style.width=w+'px';};const mu=()=>{document.removeEventListener('mousemove',mm);document.removeEventListener('mouseup',mu);};document.addEventListener('mousemove',mm);document.addEventListener('mouseup',mu);});}
        function toggleSidebar(){document.getElementById('rack-sidebar').classList.toggle('open');}
        function openAIModal(){if(!selectedLocId)return alert("Select Site"); document.getElementById('ai-modal').classList.remove('hidden');}
        async function handleAiSubmit(e){e.preventDefault(); const i=document.getElementById('ai-input'); const q=i.value; if(!q)return; document.getElementById('ai-chat-history').innerHTML+=`<div class="ai-message user">${q}</div>`; i.value=''; setTimeout(()=>{document.getElementById('ai-chat-history').innerHTML+=`<div class="ai-message bot">AI Response requires API Key.</div>`;},500);}
        function downloadSample(){alert("Sample Downloaded");}
    </script>
</body>
</html>
